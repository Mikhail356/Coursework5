# Поиск упоминаний персон
Как и было указано ранее весь поиск конкретной информации в тексте можно разбить на несколько групп в зависимости от того какой способ нормализации мы используем. Существуют разные способы нормализации текстов. На их основе существуют различные способы поиска - статистическая, усекающая и смешанная. Также можно использовать регулярные выражения.

## Определения
1. Полнотекстовый поиск $-$ поиск который ведется по всему документу или по существенной его части.
1. Стемминг $-$ процесс редуцирования слова до его основы или корня.
1. Лемматизация $-$ приведение словоформы к начальной форме.
1. Начальная форма слова $-$ единственная форма для каждого слова. В русском языке для существительных это единственное число, именительный падеж, глаголов $-$ инфинитив, прилагательные $-$ мужской род, единственное число и так далее.
1. Нормализация слова $-$ приведение слова к его начальной форме.

## Описание модели
В данной работе используется стемминг и на нем строится усекающая модель нормализации текстов, так как нет доступа к нужными вычислительными ресурсами для применения остальных.

Также так как было выгружено около 100 000 различных записей их нужно правильно индексировать и искать по ним, так как пройти 100 000 последовательностей из более чем 10 000 символов программой на языке Python довольно долго. Это связано с тем, что Python $-$ интерпретируемый язык программирования с динамической типизацией, поэтому код на этом языке, как правило, проигрывает в производительности аналогичному коду на языках программирования C/C++ как минимум на порядок (в 10 раз). Поэтому используем язык Python с подключенной к нему СУБД SQLite и прямые SQL запросы. Для полнотекстового поиска используем расширение СУБД FTS5 [@SQLiteFTS5Extension], это специальный набор команд для работы с виртуальными таблицами в СУБД SQLite и поддерживающий полнотекстовый поиск. При помощи нее создается B-дерево всех документов. Так получается кратно ускорить работу полнотекстового поиска по базе данных. Для самого полнотекстового поиска используется отбрасывание окончаний у имени, фамилии и отчества в итоге оставшаяся основа слова при помощи регулярного выражения прогоняется по всей базе текстов.

На втором этапе уже составляется таблица пересечений людей в одном тексте (то есть в одном тексте встретились 2 фамилии из базы данных сотрудников). Дальше уже на оставшихся текстах происходит прогон на наличие в тексте также соответствующих имен и отчеств. Этот этап позволяет избавиться от таких совпадений как для фамилии Орехов и слова орехи, фамилии Толстой и слова толстой. Поиск осуществляется не по всему тексту, а только по его небольшому интервалу вокруг предполагаемо найденной фамилии. В работе используется интервал от 50 до 100 символов, так как существуют двойные фамилии а также длинные южные.

Проиллюстрировать работу программы по поиску упоминаний людей в тексте можно следующей диаграммой [Рис. 2]


![text_processing.png](diagrams/text_processing)

                        Рис. 2: Работа поиска 

## Структура таблиц
```SQL 
CREATE TABLE man(id primary key, lastname, firstname, middlename, expert);
CREATE TABLE content(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    url TEXT,
    cont TEXT
);
CREATE TABLE nametext (id integer primary key AUTOINCREMENT, 
cont_id int, name_id int);
CREATE TABLE namenamecont (id integer PRIMARY KEY AUTOINCREMENT, 
name1 int, name2 int, cont_id int);
```

## Математическая модель поиска

Пусть у нас есть следующие мультимножества: 
1. $man(id(t_1), lastname(t_2), firstname(t_2), middlename(t_2), expert(t_3))$ $-$ содержит набор фамилий имен и отчеств сотрудников, где каждая запись является кортежем из $5$ полей:
    * $id$ $-$ уникальный номер для каждого кортежа
    * $lastname$ $-$ фамилия сотрудника
    * $firstname$ $-$ имя сотрудника
    * $middlename$ $-$ отчество сотрудника
    * $expert$ $-$ пометка о том, является ли данный сотрудник экспертом. Эксперт это сотрудник, который может быть выбран для написания рецензии
1. $content(id(t_1), url(t_2), cont(t_2))$ $-$ содержит набор полученных из новостных изданий очищенных текстов новостей, где каждая запись является кортежем из $3$ полей:
    * $id$ $-$ уникальный номер для каждого кортежа
    * $url$ $-$ URL новости
    * $cont$ $-$ чистый текст новости содержащийся по этому URL
1. $nametext (id(t_1), cont\text{\_}id(t_1), name\text{\_}id(t_1))$ $-$ содержит набор соответствий имен тем текстам в которых они упоминаются. Каждая запись это кортеж из $3$ полей:
    * $id$ $-$ уникальный номер для каждого кортежа
    * $cont\text{\_}id$ $-$ номер текста соответствующий $id$ этого текста в мультимножестве $content$
    * $name\text{\_}id$ $-$ номер $id$ записи о сотруднике в мультимножестве $man$
1. $namenamecont (id(t_1), name1(t_1), name2(t_1), cont\text{\_}id(t_1))$ $-$ содержит набор текстов в которых упоминается хотя бы 2 человека из таблицы $man$. Каждая запись является кортежем из $4$ полей:
    * $id$ $-$ уникальный номер для каждого кортежа
    * $name1$ $-$ номер записи о сотруднике в мультимножестве $man$, который упоминается в этом тексте
    * $name2$ $-$ номер записи о сотруднике в мультимножестве $man$, который упоминается в этом тексте
    * $cont\text{\_}id$ $-$ номер текста в котором упоминаются сотрудники совместно равный $id$ текста в мультимножестве $content$

Тогда математическая модель поиска кортежей из мультимножества 
$$man(id(t_1), lastname(t_2), firstname(t_2), middlename(t_2), expert(t_3))$$ 
в мультимножестве 
$$content(id(t_1), url(t_2), cont(t_2))$$
будет являться отображением $s: man \rightarrow \{0,1 \}^n$, где $n = \# \{id \in man\}$.
Дальше опускаем указание типов, так как они остаются неизменными. Функцию стемминга обозначим:
$$stem(a_1...a_n) = \begin{cases} a_1...a_n, \text{ если  } a_n \neq  "a" \\ a_1...a_{n-1}, \text{ иначе} \end{cases}$$
Тогда узнать есть ли упоминание человека $\pi(man)_{\sigma(id = t)}$ в таблице текстов $content$ можно так
$$s_1(\pi(man)_{\sigma(id = t)}, content) :=$$
$$ \{(t,\quad H(\#\bigcup\limits_{g = 1}^{\#\{id \in content\}} \pi(content)_{\sigma(stem(man(id=t, lastname)) \in content(id = g, cont))})),\},$$
где $H$ сдвинутая функция Хевисайда:
$$H: \mathbb{N} \rightarrow \{0,1\}$$
$$H(n) =  \begin{cases} 0,\quad n < 1\\ 1, \quad n \ge 1 \end{cases}$$

Узнать же записи в которых упоминается человек можно следующим образом:

$$s_0(\pi(man)_{\sigma(id = t)}, content) :=$$
$$ \{(t, \quad\bigcup\limits_{g = 1}^{\#\{id \in content\}} \pi(content(id))_{\sigma(stem(man(id=t, lastname)) \in content(id = g, cont))}),\}$$

Если будет искаться несколько элементов из таблицы, то ответом будут множества размера в количество разыскиваемых элементов. Каждый элемент будет являться упорядоченной парой с первым аргументом номером id, а вторым найденными значениями. Эти данные и заносятся в таблицу $nametext$.

Результатом же заносимым в таблицу $namenamecont$ будет пересечение $s_0(\pi(man)_{\sigma(id = t)}, content)$ и $s_0(\pi(man)_{\sigma(id = j)}, content)$ по всем $j\neq t$.

Чтобы найти позицию элемента $a_1...a_n$ в тексте $text$ будем использовать $fts(a_1...a_n, text)$.
Тогда узнать позицию слова в тексте можно так:
$$s_2(\pi(man)_{\sigma(id = t)}, content) :=$$
$$ \{(t, \quad\bigcup\limits_{g = 1}^{\#\{id \in content\}} fts(stem(man(id=t, lastname)),$$
$$\pi(content(cont))_{\sigma(stem(man(id=t, lastname)) \in content(id = g, cont))})),\}$$

## Замечания о реализации

Получившаяся математическая модель была реализована на языков программирования Python и SQL. Полученная программа была проверена для 100 000 текстов. В результате остается примерно 1% текстов, в которых упоминается хотя бы один сотрудник, и 0.05% $-$ где упоминаются хотя бы 2 сотрудника. Если ограничить стемминг только фамилией, тем самым увеличив полноту поиска, то количество текстов возрастает, но падает его качество. Возникают срабатывания на фамилию Орехов и части предложения в духе $\textquote{\text{Ореховые волокна обладают свойством связывать ...}}$ или фамилии Толстой и $\textquote{\text{... вызывает опухоли в толстой кишке ...}}$. Также есть проблемы своевременного обновления базы людей, так в базе данных не было данных о докторе химических наук, сотруднике РАН Иване Смирнове, но при этом была новость где он упоминался именно в этом ключе. При этом добавление требования совпадения имени тоже не до конца решает задачу. В базе данных есть сотрудник Иван Смирнов и при этом есть текст $\textquote{\text{Владимир Смирнов лишился должности в результате авиаколлапса...}}$ в котором говорится о бывшем руководителе авиационной компании, который не был сотрудником РАН. Время составления таблицы соответствий текстов упоминаемых в ним именам для 100 000 текстов и 1400 сотрудников составляет 35 минут. Построение же итоговой таблицы с текстами где упоминается хотя бы 2 человека занимает $\approx$ 2.18 секунд. Сама таблица при этом содержит 178 тысяч записей.

